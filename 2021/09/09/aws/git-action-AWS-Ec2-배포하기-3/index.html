<!doctype html>
<html lang="ko"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>git action AWS Ec2 배포하기 3 - Juryeon Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Juryeon Blog"><meta name="msapplication-TileImage" content="/image/og_image.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Juryeon Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Git Action Ec2 Codedeploy 자동배포 하기 3. AWS의 설정을 모두 마치고 git에서 git action을 통해 자동배포를 진행해보도록 한다.자동 배포를 진행하기위해 진행해야 하는 과정은 다음과 같다.  git action workflow 작성 appspec.yml 작성 .sh 스크립트 작성  3가지의 과정을 하나씩 진행해보자."><meta property="og:type" content="blog"><meta property="og:title" content="git action AWS Ec2 배포하기 3"><meta property="og:url" content="http://hanjuren.github.io/2021/09/09/aws/git-action-AWS-Ec2-%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0-3/"><meta property="og:site_name" content="Juryeon Blog"><meta property="og:description" content="Git Action Ec2 Codedeploy 자동배포 하기 3. AWS의 설정을 모두 마치고 git에서 git action을 통해 자동배포를 진행해보도록 한다.자동 배포를 진행하기위해 진행해야 하는 과정은 다음과 같다.  git action workflow 작성 appspec.yml 작성 .sh 스크립트 작성  3가지의 과정을 하나씩 진행해보자."><meta property="og:locale" content="ko_KR"><meta property="og:image" content="https://ifh.cc/g/GnicOz.png"><meta property="og:image" content="https://ifh.cc/g/bEWUiK.png"><meta property="og:image" content="https://ifh.cc/g/pwdJyF.png"><meta property="article:published_time" content="2021-09-09T08:45:34.000Z"><meta property="article:modified_time" content="2021-12-05T05:38:52.426Z"><meta property="article:author" content="han Ju Ryeon"><meta property="article:tag" content="ec2"><meta property="article:tag" content="aws"><meta property="article:tag" content="github"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://ifh.cc/g/GnicOz.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://hanjuren.github.io/2021/09/09/aws/git-action-AWS-Ec2-%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0-3/"},"headline":"git action AWS Ec2 배포하기 3","image":["https://ifh.cc/g/GnicOz.png","https://ifh.cc/g/bEWUiK.png","https://ifh.cc/g/pwdJyF.png"],"datePublished":"2021-09-09T08:45:34.000Z","dateModified":"2021-12-05T05:38:52.426Z","author":{"@type":"Person","name":"han Ju Ryeon"},"publisher":{"@type":"Organization","name":"Juryeon Blog","logo":{"@type":"ImageObject","url":"http://hanjuren.github.io/images/bloglogo.png"}},"description":"Git Action Ec2 Codedeploy 자동배포 하기 3. AWS의 설정을 모두 마치고 git에서 git action을 통해 자동배포를 진행해보도록 한다.자동 배포를 진행하기위해 진행해야 하는 과정은 다음과 같다.  git action workflow 작성 appspec.yml 작성 .sh 스크립트 작성  3가지의 과정을 하나씩 진행해보자."}</script><link rel="canonical" href="http://hanjuren.github.io/2021/09/09/aws/git-action-AWS-Ec2-%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0-3/"><link rel="icon" href="/image/og_image.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/rss2.xml" title="Juryeon Blog" type="application/rss+xml">
</head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/bloglogo.png" alt="Juryeon Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="external nofollow noopener noreferrer" title="Download on GitHub" href="https://github.com/hanjuren"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="카탈로그" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="검색" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-9-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time datetime="2021-09-09T08:45:34.000Z" title="9/9/2021, 5:45:34 PM">2021-09-09</time>&nbsp;게시 됨</span><span class="level-item"><time datetime="2021-12-05T05:38:52.426Z" title="12/5/2021, 2:38:52 PM">2021-12-05</time>&nbsp;업데이트 됨</span><span class="level-item"><a class="link-muted" href="/categories/aws/">aws</a><span> / </span><a class="link-muted" href="/categories/ec2/">ec2</a><span> / </span><a class="link-muted" href="/categories/github/">github</a></span></div></div><h1 class="title is-3 is-size-4-mobile">git action AWS Ec2 배포하기 3</h1><div class="content"><h2 id="Git-Action-Ec2-Codedeploy-자동배포-하기-3"><a href="#Git-Action-Ec2-Codedeploy-자동배포-하기-3" class="headerlink" title="Git Action Ec2 Codedeploy 자동배포 하기 3."></a>Git Action Ec2 Codedeploy 자동배포 하기 3.</h2>
<p>AWS의 설정을 모두 마치고 git에서 git action을 통해 자동배포를 진행해보도록 한다.<br>자동 배포를 진행하기위해 진행해야 하는 과정은 다음과 같다.</p>
<ol>
<li>git action workflow 작성</li>
<li>appspec.yml 작성</li>
<li>.sh 스크립트 작성</li>
</ol>
<p>3가지의 과정을 하나씩 진행해보자.</p>
<span id="more"></span>

<h3 id="git-action-workflow-작성하기"><a href="#git-action-workflow-작성하기" class="headerlink" title="git action workflow 작성하기"></a>git action workflow 작성하기</h3>
<h4 id="git-action이란"><a href="#git-action이란" class="headerlink" title="git action이란?"></a>git action이란?</h4>
<p>github의 저장소를 기반으로 하여 작성한 스크립트를 이용하여 작업을 진행해주는 서비스이다.<br>git workflow는 저장소에서 일어나는 특성 이벤트시 구동될 스크립트를 작성해주고 git이 이벤트를 감지하여 테스트, 배포 등의 작업을 진행한다.<br>작업의 환경은 window, mac, linux 환경에서 구동 할 수 있으며 다양한 스크립트의 샘플이 존재하고 있다.</p>
<h4 id="git-action-workflow작성하기"><a href="#git-action-workflow작성하기" class="headerlink" title="git action workflow작성하기"></a>git action workflow작성하기</h4>
<p>먼저 작업을 진행하던 레파지토리로 들어간다. 이후 상단의 action 탭을 클릭하면 다음과 같은 화면이 보여진다.<br><img src="https://ifh.cc/g/GnicOz.png"><br></p>
<p>이후 node.js 워크플로우를 클릭하여 샘플 스크립트를 받는다. 샘플 스크립트의 형태는 다음과 같다.</p>
<p><img src="https://ifh.cc/g/bEWUiK.png"><br></p>
<p>해당 스크립트를 이용하여 작업을 진행하기 위해 우측 상단의 커밋실행을 누르고 로컬 작업 환경으로 레파지토리를 pull로 업데이트를 해준다.</p>
<p>그러면 우리의 로컬 작업 폴더에 다음과 같은 폴더와 파일이 추가된다. 폴더구조는 다음과 같다.</p>
<p><img src="https://ifh.cc/g/pwdJyF.png"><br></p>
<p>node.js.yml파일을 수정하여 자동배포를 위한 과정을 작성해주면 된다.</p>
<figure class="highlight yml">
<table>
  <tr>
    <td class="gutter">
      <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre>
    </td>
    <td class="code">
      <pre><span class="line"><span class="comment"># node.js.yml</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">Build</span> <span class="string">&amp;</span> <span class="string">Deploy</span></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">PROJECT_NAME:</span> <span class="string">Nestjs-app</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-18.04</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">AWS</span> <span class="string">credentials</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">aws-actions/configure-aws-credentials@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">aws-access-key-id:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.AWS_ACCESS_KEY_ID</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">aws-secret-access-key:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.AWS_SECRET_ACCESS_KEY</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">aws-region:</span> <span class="string">ap-northeast-2</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Use</span> <span class="string">Node.js</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-node@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">node-version:</span> <span class="string">&#x27;14.x&#x27;</span> </span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">delete</span> <span class="string">package-lock.json</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">rm</span> <span class="string">package-lock.json</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Dependencies</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line">          </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">env</span> <span class="string">file</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          mkdir secret</span></span><br><span class="line"><span class="string">          cd secret    </span></span><br><span class="line"><span class="string">          touch .env.development    </span></span><br><span class="line"><span class="string">          cat &lt;&lt; EOF &gt;&gt; .env.development    </span></span><br><span class="line"><span class="string">          $&#123;&#123; secrets.ENV &#125;&#125;</span></span><br><span class="line"><span class="string">          EOF</span></span><br><span class="line"><span class="string">          cd ../</span></span><br><span class="line"><span class="string"></span>      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Make</span> <span class="string">tar</span> <span class="string">file</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">tar</span> <span class="string">-cpvzf</span> <span class="string">./$GITHUB_SHA.tgz</span> <span class="string">*</span></span><br><span class="line">        <span class="attr">shell:</span> <span class="string">bash</span></span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Upload</span> <span class="string">to</span> <span class="string">S3</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          aws s3 cp \</span></span><br><span class="line"><span class="string">            --region ap-northeast-2 \</span></span><br><span class="line"><span class="string">            ./$GITHUB_SHA.tgz s3://nestjs-s3-test/$PROJECT_NAME/$GITHUB_SHA.tgz</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Code</span> <span class="string">Deploy</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">aws</span> <span class="string">deploy</span> <span class="string">create-deployment</span> <span class="string">--application-name</span> <span class="string">Nesjs-App</span> <span class="string">--file-exists-behavior</span> <span class="string">OVERWRITE</span> <span class="string">--deployment-config-name</span> <span class="string">CodeDeployDefault.OneAtATime</span> <span class="string">--deployment-group-name</span> <span class="string">Nestjs-group</span> <span class="string">--s3-location</span> <span class="string">bucket=nestjs-s3-test,bundleType=tgz,key=$PROJECT_NAME/$GITHUB_SHA.tgz</span></span><br><span class="line"></span><br></pre>
    </td>
  </tr>
</table>
</figure>

<p>전체적인 내용은 이렇게 생겼다. 부분적으로 이해를 해보자면 </p>
<figure class="highlight yml">
<table>
  <tr>
    <td class="gutter">
      <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
    </td>
    <td class="code">
      <pre><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">main</span></span><br></pre>
    </td>
  </tr>
</table>
</figure>
<p>on 태그는 어떤 이벤트가 일어날때 밑에 작성한 스크립트를 실행할지 정하는 것이다. 여기서는 main브랜치에 push가 될때 작업을 실행하기로 지정해두었다.</p>
<figure class="highlight yml">
<table>
  <tr>
    <td class="gutter">
      <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
    </td>
    <td class="code">
      <pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-18.04</span></span><br></pre>
    </td>
  </tr>
</table>
</figure>
<p>git action 작업을 우분투 환경에서 실행한다는 의미이며 윈도우나 맥 또다른 리눅스 OS를 사용하여 작업해도 된다. 하지만 Ec2인스턴스에 배포할 예정이기 때문에 리눅스 환경에서 작업하는 것을 추천한다.</p>
<figure class="highlight yml">
<table>
  <tr>
    <td class="gutter">
      <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
    </td>
    <td class="code">
      <pre><span class="line"><span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">AWS</span> <span class="string">credentials</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">aws-actions/configure-aws-credentials@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">aws-access-key-id:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.AWS_ACCESS_KEY_ID</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">aws-secret-access-key:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.AWS_SECRET_ACCESS_KEY</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">aws-region:</span> <span class="string">ap-northeast-2</span></span><br></pre>
    </td>
  </tr>
</table>
</figure>
<p>steps는 밑으로 나열된 작업들을 순차적으로 실행한다는 의미이다. 먼저 aws에 사용자 인증을 위해 인증 절차를 진행해준다. secrets. 으로 작성된 부분은 git 레파지토리 세팅 탭에서 작성할수 있으며 비밀키 갑을 불러와 과정을 진행한다. 자세한 내용은 생략하도록 한다.</p>
<figure class="highlight yml">
<table>
  <tr>
    <td class="gutter">
      <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre>
    </td>
    <td class="code">
      <pre><span class="line"><span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Use</span> <span class="string">Node.js</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-node@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">node-version:</span> <span class="string">&#x27;14.x&#x27;</span> </span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">delete</span> <span class="string">package-lock.json</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">rm</span> <span class="string">package-lock.json</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Dependencies</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line">          </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">env</span> <span class="string">file</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          mkdir secret</span></span><br><span class="line"><span class="string">          cd secret    </span></span><br><span class="line"><span class="string">          touch .env.development    </span></span><br><span class="line"><span class="string">          cat &lt;&lt; EOF &gt;&gt; .env.development    </span></span><br><span class="line"><span class="string">          $&#123;&#123; secrets.ENV &#125;&#125;</span></span><br><span class="line"><span class="string">          EOF</span></span><br><span class="line"><span class="string">          cd ../</span></span><br></pre>
    </td>
  </tr>
</table>
</figure>
<p>nodejs기반 프로젝트를 빌드하기위해 nodejs 환경에서 다음의 작업을 진행한다라고 명시해준 후 pakage-lock.json파일을 지워준다. 이유는 애초에 깃에 올리지 않아도 되지만 올려진 상태에서 리눅스에서 npm install을 할 경우 윈도우 작업 환경과 충돌하는 패키지가 있을 수 있기 때문에 지우고 다시 npm install을 통해 생성해준다.<br>이후 빌드 과정을 거친 후 env파일을 생성해준다.<br>폴더를 만들고 진행하는 이유는 gitignore에 걸려서 s3에 같이 업로드가 안되길래 새로운 폴더를 통해 작성하고 ec2환경에서 다시 복사해오는 방식을 선택했다… 더 좋은 방법이 있겠지만 해당 방법을 택했다…</p>
<figure class="highlight yml">
<table>
  <tr>
    <td class="gutter">
      <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
    </td>
    <td class="code">
      <pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Make</span> <span class="string">tar</span> <span class="string">file</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">tar</span> <span class="string">-cpvzf</span> <span class="string">./$GITHUB_SHA.tgz</span> <span class="string">*</span></span><br><span class="line">        <span class="attr">shell:</span> <span class="string">bash</span></span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Upload</span> <span class="string">to</span> <span class="string">S3</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          aws s3 cp \</span></span><br><span class="line"><span class="string">            --region ap-northeast-2 \</span></span><br><span class="line"><span class="string">            ./$GITHUB_SHA.tgz s3://nestjs-s3-test/$PROJECT_NAME/$GITHUB_SHA.tgz</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Code</span> <span class="string">Deploy</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">aws</span> <span class="string">deploy</span> <span class="string">create-deployment</span> <span class="string">--application-name</span> <span class="string">Nesjs-App</span> <span class="string">--file-exists-behavior</span> <span class="string">OVERWRITE</span> <span class="string">--deployment-config-name</span> <span class="string">CodeDeployDefault.OneAtATime</span> <span class="string">--deployment-group-name</span> <span class="string">Nestjs-group</span> <span class="string">--s3-location</span> <span class="string">bucket=nestjs-s3-test,bundleType=tgz,key=$PROJECT_NAME/$GITHUB_SHA.tgz</span></span><br></pre>
    </td>
  </tr>
</table>
</figure>

<p>프로젝트 폴더내용을 압축하여 S3버킷에 업로드하는 과정 이후 codedeploy가 해당 파일을 읽고 실행할 수 있도록해주는 내용이다. 조금 디테일하게 보자면 </p>
<ul>
<li>‘./$GITHUB_SHA.tgz s3://버킷이름/$PROJECT_NAME/$GITHUB_SHA.tgz’</li>
<li>‘–application-name 애플리케이션 이름’</li>
<li>‘–deployment-group-name 배포그룹이름’</li>
<li>‘–s3-location bucket=버킷이름,bundleType=tgz,key=$PROJECT_NAME/$GITHUB_SHA.tgz’ &lt;- 압축한 파일 이름과 경로</li>
</ul>
<hr>
<h4 id="appspec-yml-작성"><a href="#appspec-yml-작성" class="headerlink" title="appspec.yml 작성"></a>appspec.yml 작성</h4>
<p>해당 파일은 Codedeploy배포시 ec2인스턴스 내에서 실행 하게 될 스크립트를 정의하는 파일이다.</p>
<figure class="highlight yml">
<table>
  <tr>
    <td class="gutter">
      <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre>
    </td>
    <td class="code">
      <pre><span class="line"><span class="comment"># appspec.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">0.0</span></span><br><span class="line"><span class="attr">os:</span> <span class="string">linux</span></span><br><span class="line"></span><br><span class="line"><span class="attr">files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">destination:</span> <span class="string">/home/ec2-user/nest-app</span></span><br><span class="line"><span class="attr">permissions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">object:</span> <span class="string">/home/ec2-user</span></span><br><span class="line">    <span class="attr">pattern:</span> <span class="string">&#x27;**&#x27;</span></span><br><span class="line">    <span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">hooks:</span></span><br><span class="line">  <span class="attr">BeforeInstall:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">location:</span> <span class="string">scripts/before_deploy.sh</span></span><br><span class="line">      <span class="attr">runas:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">AfterInstall:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">location:</span> <span class="string">scripts/after_deploy.sh</span></span><br><span class="line">      <span class="attr">runas:</span> <span class="string">root</span></span><br></pre>
    </td>
  </tr>
</table>
</figure>

<p>내용의 구성은 스크립트가 실행될 디렉토리를 적고 해당 위치에서 실행될 스크립트 파일의 이름을 지정한다.<br>BeforeInstall은 프로젝트가 실행되기 이전의 작업을 지정해놓은 파일이고 AfterInstall은 프로젝트 앱을 실행할 스크립트의 파일이다.</p>
<figure class="highlight sh">
<table>
  <tr>
    <td class="gutter">
      <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
    </td>
    <td class="code">
      <pre><span class="line"><span class="comment"># scripts/before_deploy.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">REPOSITORY=/home/ec2-user</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$REPOSITORY</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pm2 <span class="built_in">kill</span></span><br><span class="line"></span><br><span class="line">sudo rm -rf nest-app</span><br></pre>
    </td>
  </tr>
</table>
</figure>
<p>많은 내용을 포함하여 작성해도 되지만 여기서는 간단하게 작업을 진행했다.</p>
<ol>
<li>pm2로 실행되고 있는 프로세스를 모두 종료한다. 하나의 인스턴스에 여러개의 노드를 사용하는 프로세스가 있다면 한번에 종료시키는 명령어는 문제가 될 수 있기때문에 주의가 필요하다.</li>
<li>기존의 프로젝트 폴더를 삭제해준다.</li>
</ol>
<figure class="highlight sh">
<table>
  <tr>
    <td class="gutter">
      <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
    </td>
    <td class="code">
      <pre><span class="line"><span class="comment"># scripts/after_deploy.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">REPOSITORY=/home/ec2-user/nest-app</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$REPOSITORY</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># nvm 환경변수 등록</span></span><br><span class="line"><span class="built_in">export</span> NVM_DIR=<span class="string">&quot;/home/ec2-user/.nvm&quot;</span></span><br><span class="line">[ -s <span class="string">&quot;<span class="variable">$NVM_DIR</span>/nvm.sh&quot;</span> ] &amp;&amp; \. <span class="string">&quot;<span class="variable">$NVM_DIR</span>/nvm.sh&quot;</span></span><br><span class="line">[ -s <span class="string">&quot;<span class="variable">$NVM_DIR</span>/bash_completion&quot;</span> ] &amp;&amp; \. <span class="string">&quot;<span class="variable">$NVM_DIR</span>/bash_completion&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> secret</span><br><span class="line">sudo mv .env.development ../</span><br><span class="line"><span class="built_in">cd</span> ../</span><br><span class="line">rm -rf secret</span><br><span class="line"></span><br><span class="line">npm start</span><br></pre>
    </td>
  </tr>
</table>
</figure>
<ol>
<li>workflow에서 생성한 env파일을 프로젝트의 루트 디렉토리로 옮겨 와주는 작업을 한다.</li>
<li>이후 start 스크립트를 실행하여 프로젝트를 구동 시킨다.</li>
</ol>
<p>nvm 환경변수 등록은 npm 명령어가 인스턴스에 직접 접속했을때는 실행되는데 배포과정에서는 실행되지 않는 문제가 있어서 환경변수를 등록하고 사용하는 과정이다.</p>
<hr>
<p>모든 스크립트 파일을 작성했으니 다음과정에서 배포가 되는지 테스트를 진행해보도록 한다.</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>git action AWS Ec2 배포하기 3</p><p><a href="http://hanjuren.github.io/2021/09/09/aws/git-action-AWS-Ec2-배포하기-3/">http://hanjuren.github.io/2021/09/09/aws/git-action-AWS-Ec2-배포하기-3/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>han Ju Ryeon</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2021-09-09</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2021-12-05</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="external nofollow noopener noreferrer" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="external nofollow noopener noreferrer" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="external nofollow noopener noreferrer" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/ec2/">ec2</a><a class="link-muted mr-2" rel="tag" href="/tags/aws/">aws</a><a class="link-muted mr-2" rel="tag" href="/tags/github/">github</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/09/09/aws/git-action-AWS-Ec2-%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0-4/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">git action AWS Ec2 배포하기 4</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/09/09/aws/git-action-AWS-Ec2-%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0-2/"><span class="level-item">git action AWS Ec2 배포하기 2</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">댓글</h3><div class="notification is-danger">You forgot to set the <code>shortname</code> for Disqus. Please set it in <code>_config.yml</code>.</div></div></div></div><div class="column column-left is-4-tablet is-3-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/images/profile.png" alt="Han Ju Ryeon"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Han Ju Ryeon</p><p class="is-size-6 is-block">새로운것을 배우기 위해 노력하는 삶</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>경기도 의왕시</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">포스트</p><a href="/archives"><p class="title">55</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">카테고리</p><a href="/categories"><p class="title">18</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">태그</p><a href="/tags"><p class="title">19</p></a></div></div></nav><div class="level"><a class="level-item button is-info is-outlined is-rounded" href="/" target="_blank" rel="noopener">HOME</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="external nofollow noopener noreferrer" title="Github" href="https://github.com/hanjuren"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">카탈로그</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Git-Action-Ec2-Codedeploy-자동배포-하기-3"><span class="level-left"><span class="level-item">1</span><span class="level-item">Git Action Ec2 Codedeploy 자동배포 하기 3.</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#git-action-workflow-작성하기"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">git action workflow 작성하기</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#git-action이란"><span class="level-left"><span class="level-item">1.1.1</span><span class="level-item">git action이란?</span></span></a></li><li><a class="level is-mobile" href="#git-action-workflow작성하기"><span class="level-left"><span class="level-item">1.1.2</span><span class="level-item">git action workflow작성하기</span></span></a></li><li><a class="level is-mobile" href="#appspec-yml-작성"><span class="level-left"><span class="level-item">1.1.3</span><span class="level-item">appspec.yml 작성</span></span></a></li></ul></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/bloglogo.png" alt="Juryeon Blog" height="28"></a><p class="is-size-7"><span>&copy; 2022 han Ju Ryeon</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="external nofollow noopener noreferrer">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="external nofollow noopener noreferrer">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="external nofollow noopener noreferrer" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="external nofollow noopener noreferrer" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="external nofollow noopener noreferrer" title="Download on GitHub" href="https://github.com/hanjuren"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("ko");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="맨 위로" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "이 웹 사이트는 귀하의 경험을 향상시키기 위해 Cookie를 사용합니다.",
          dismiss: "무시",
          allow: "허용",
          deny: "거부",
          link: "더 알아보기",
          policy: "Cookie 정책",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="입력 하세요..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"입력 하세요...","untitled":"(제목 없음)","posts":"포스트","pages":"페이지","categories":"카테고리","tags":"태그"});
        });</script></body></html>